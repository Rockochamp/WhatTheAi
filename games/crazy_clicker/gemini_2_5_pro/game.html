<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <title>Crazy Clicker - What the Ai</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <style>
        /* Base Styles */
        body {
            background: #1a1a1a; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 0; text-align: center;
            /* Removed height, overflow, and flex properties */
        }
        /* Added Main Wrapper */
        .main-wrapper {
            position: relative; /* Context for absolute children */
            min-height: 100vh; /* Ensure it tries to fill viewport */
            display: flex;
            flex-direction: column;
            /* justify-content: center; /* Removed, let content flow */
        }
        .breadcrumb { position: absolute; top: 10px; left: 10px; z-index: 30; /* Increased z-index */ background-color: rgba(255, 255, 255, 0.7); padding: 5px 10px; border-radius: 5px; font-family: Arial, sans-serif; }
        .breadcrumb a { text-decoration: none; color: #333; font-size: 1em; }
        .version-indicator { position: absolute; top: 10px; right: 10px; z-index: 30; /* Increased z-index */ background-color: rgba(255, 255, 255, 0.7); padding: 5px 10px; border-radius: 5px; font-family: Arial, sans-serif; color: #333; font-size: 0.9em; }

        /* Start Page */
        #startScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px 20px 20px; /* Added top padding */ }
        #playerInfo label { color: #fff; margin-bottom: 5px; }
        #playerInfo input { padding: 8px; font-size: 1em; margin-bottom: 10px; width: 80%; max-width: 250px; text-align: center; border-radius: 4px; border: 1px solid #ccc; }
        #playerInfo button { padding: 10px 20px; font-size: 1.1em; cursor: pointer; border-radius: 4px; background-color: #4CAF50; color: white; border: none; }
        #globalLeaderboardStart { background: #222; padding: 10px 15px; width: 90%; max-width: 300px; border: 2px solid #fff; margin: 20px auto 0; box-sizing: border-box; text-align: left; border-radius: 5px;}
        #globalLeaderboardStart h2 { margin-top: 0; margin-bottom: 10px; text-align: center; font-size: 1.1em; }
        #globalLeaderboardStart ol { padding-left: 20px; margin: 0; }
        #globalLeaderboardStart li { margin-bottom: 5px; font-size: 0.9em; }
        #globalLeaderboardStart p { text-align: center; font-style: italic; color: #aaa; margin: 5px 0; }
        .totalGamesText { font-size: 0.8em; margin: 0 0 10px 0; padding: 0; color: #ccc; text-align: center; }

        /* Game Area */
        #gameScreen {
            display: none; /* Hidden initially */
            flex-grow: 1; /* Take remaining space within the wrapper */
            width: 100%;
            position: relative; /* Needed for absolute positioning of children */
            display: flex; /* Use flexbox for centering */
            flex-direction: column;
            justify-content: center; /* Center vertically */
            align-items: center; /* Center horizontally */
            cursor: pointer;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight */
            user-select: none; /* Prevent text selection */
            -webkit-user-select: none;
        }
        #scoreDisplay {
            /* Removed absolute positioning, rely on flexbox */
            font-size: 3em;
            font-weight: bold;
            color: #fff;
            z-index: 5;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px; /* Add some space below score */
        }
        #instructionText {
             /* Removed absolute positioning, rely on flexbox */
            font-size: 1.2em;
            color: #ccc; /* Reverted color */
            z-index: 5;
        }


        /* Game Over Screen */
        #gameOverScreen {
            display: none; /* Hidden initially */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.8); /* Semi-transparent overlay */
            position: absolute; /* Cover game area */
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 20;
            overflow-y: auto; /* Allow scrolling if content overflows */
        }
        #gameOverScreen h2 { font-size: 2em; margin-bottom: 15px; color: #ff4d4d; }
        #finalScore { font-size: 1.5em; margin-bottom: 15px; } /* Reduced margin */
        /* Styles for both leaderboard boxes */
        .leaderboard-box { background: #222; padding: 10px 15px; width: 90%; max-width: 300px; border: 2px solid #fff; margin-bottom: 15px; box-sizing: border-box; text-align: left; border-radius: 5px;}
        .leaderboard-box h3 { margin-top: 0; margin-bottom: 10px; text-align: center; font-size: 1.1em; }
        .leaderboard-box ol { padding-left: 20px; margin: 0; }
        .leaderboard-box li { margin-bottom: 5px; font-size: 0.9em; }
        .leaderboard-box p { text-align: center; font-style: italic; color: #aaa; margin: 5px 0; }
        #nextRoundButton { padding: 12px 25px; font-size: 1.2em; cursor: pointer; border-radius: 4px; background-color: #4CAF50; color: white; border: none; margin-top: 5px; /* Added margin */ }

        /* Volume Control Styles (Copied & Adjusted from Cosmic Dodge) */
        .volume-control-container {
            position: absolute;
            top: 10px;
            right: 150px; /* Position left of version indicator (adjust as needed) */
            z-index: 30; /* Ensure visibility */
            background-color: rgba(34, 34, 34, 0.8); /* #222 with opacity */
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: none; /* Hidden by default, shown by JS */
            align-items: center; /* Align items vertically */
            gap: 8px; /* Space between elements */
        }
        .volume-control-container label {
            font-size: 0.8em;
            color: #ccc;
            margin: 0; /* Reset margin */
            display: inline-block; /* Keep label inline */
            vertical-align: middle;
        }
        .volume-control-container input[type="range"] {
            width: 80px; /* Adjust width */
            cursor: pointer;
            -webkit-appearance: none; appearance: none;
            height: 6px; background: #555; border-radius: 3px; outline: none;
            vertical-align: middle;
        }
        .volume-control-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 14px; height: 14px; background: #00ffcc; border-radius: 50%; cursor: pointer;
        }
        .volume-control-container input[type="range"]::-moz-range-thumb {
            width: 14px; height: 14px; background: #00ffcc; border-radius: 50%; cursor: pointer; border: none;
        }
        /* Mute Toggle Styles */
        #muteControl {
            display: none; /* Hidden by default, shown via JS on iOS */
            padding: 0; /* Reset padding */
            margin: 0; /* Reset margin */
            line-height: 1; /* Adjust line height */
        }
        #muteControl input[type="checkbox"] {
            margin-right: 5px;
            vertical-align: middle;
            width: 14px; height: 14px;
            cursor: pointer;
        }
        #muteControl label#muteToggleLabel {
            display: inline-block;
            vertical-align: middle;
            margin-bottom: 0;
            cursor: pointer;
            color: #ccc;
            font-size: 0.8em;
        }

        /* Flicker Effects */
        .flicker-green {
            animation: flicker-green-anim 0.1s ease-out;
        }
        @keyframes flicker-green-anim {
            0% { background-color: rgba(0, 255, 0, 0.3); }
            100% { background-color: transparent; }
        }
        .flicker-red {
            animation: flicker-red-anim 1s ease-out;
        }
        @keyframes flicker-red-anim {
            0% { background-color: rgba(255, 0, 0, 0.7); }
            100% { background-color: transparent; }
        }

        /* Responsive */
        @media (max-width: 768px) { /* Adjust breakpoint for volume control */
             .volume-control-container {
                 right: 10px; /* Move closer to edge */
                 top: 70px; /* Increased top margin to move below version indicator */
                 width: auto; /* Allow shrinking */
                 padding: 4px 8px;
                 gap: 5px;
             }
             .volume-control-container input[type="range"] { width: 60px; }
             .version-indicator { top: 40px; right: 10px; } /* Move version down too */
             .breadcrumb { top: 40px; } /* Move breadcrumb down too */
        }

        @media (max-width: 600px) {
            /* Score/Instruction centering handled by flexbox */
            #scoreDisplay { font-size: 2.5em; }
            #instructionText { font-size: 1em; }
            #playerInfo input { font-size: 0.9em; }
            #playerInfo button { font-size: 1em; }
            #globalLeaderboardStart, .leaderboard-box { max-width: 95%; } /* Applied to new class */
            #gameOverScreen h2 { font-size: 1.8em; }
            #finalScore { font-size: 1.3em; }
            #nextRoundButton { font-size: 1.1em; }
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity - Adjusted to match Hammurabi */
            backdrop-filter: blur(3px);         /* Added blur effect */
            -webkit-backdrop-filter: blur(3px); /* Added Safari compatibility */
            padding-top: 60px; /* Location of the box */
        }
        .modal-content {
            background-color: #2a2a2a;
            margin: 5% auto; /* 5% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* Could be more or less, depending on screen size */
            max-width: 500px; /* Maximum width */
            border-radius: 8px;
            position: relative;
            color: #fff;
            max-height: 80vh; /* Limit height */
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
            text-align: center;
            font-size: 1.3em;
            margin-bottom: 15px;
        }
        .modal-body {
            flex-grow: 1; /* Take available space */
            overflow-y: auto; /* Enable scrolling for the list */
    padding-right: 10px; /* Space for scrollbar */
}
.modal-body ol {
    padding-left: 30px; /* Add space for list numbers */
    margin: 0; /* Reset margin */
    list-style-position: outside; /* Default, numbers outside */
    text-align: left; /* Align text left */
}
.modal-body li { margin-bottom: 6px; font-size: 0.95em; }
.modal-body p { text-align: center; font-style: italic; color: #aaa; margin: 10px 0; }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }
        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
        /* Make leaderboard boxes clickable */
        #globalLeaderboardStart, #globalLeaderboardGameOver, #localRankingBoard {
             cursor: pointer;
        }
        #globalLeaderboardStart:hover, #globalLeaderboardGameOver:hover, #localRankingBoard:hover {
             border-color: #00ffcc; /* Highlight on hover */
        }

    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="main-wrapper"> <!-- Added Wrapper -->
    <div class="breadcrumb"> <a href="/index.html">Back to Games</a> </div>
    <!-- Volume Control Added Here -->
    <div class="volume-control-container" id="volumeControlContainer">
        <!-- Volume Slider (shown on non-iOS) -->
        <label for="volumeSlider" id="volumeSliderLabel">Vol:</label>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5">
        <!-- Mute Toggle (shown on iOS) -->
        <div id="muteControl">
           <input type="checkbox" id="muteToggle">
           <label for="muteToggle" id="muteToggleLabel">Mute</label>
        </div>
    </div>
    <div class="version-indicator" id="versionIndicator"> Gemini 2.5 Pro </div>

    <!-- Start Screen -->
    <div id="startScreen">
        <h1>Crazy Clicker</h1>
        <div id="playerInfo">
            <label for="playerName">Player Name (max 10 chars): </label>
            <input type="text" id="playerName" maxlength="10" placeholder="Enter your name" />
            <button id="startGame">Start Game</button>
        </div>
        <div id="globalLeaderboardStart">
            <h2>Global Leaderboard</h2>
            <p id="globalGamesPlayedStart" class="totalGamesText">(Total games played worldwide: Loading...)</p>
            <div id="globalRankingContentStart">Loading...</div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen">
        <div id="scoreDisplay">0</div>
        <div id="instructionText">Click anywhere to start...</div>
        <!-- This div covers the screen for clicks -->
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen">
        <h2>Game Over!</h2>
        <div id="finalScore">Final Score: 0</div>
        <!-- Added Local Ranking Box -->
        <div id="localRankingBoard" class="leaderboard-box">
            <h3>Local Ranking</h3>
            <div id="localRankingContent">No rounds played yet.</div>
        </div>
        <!-- Updated Global Leaderboard Box ID and Class -->
        <div id="globalLeaderboardGameOver" class="leaderboard-box">
            <h3>Global Leaderboard</h3>
            <p id="globalGamesPlayedGameOver" class="totalGamesText">(Total games played worldwide: Loading...)</p>
            <div id="globalRankingContentGameOver">Loading...</div>
        </div>
        <button id="nextRoundButton">Next Round</button>
    </div>

    <!-- Added Audio Element -->
    <audio id="backgroundMusic" loop> <source src="/music/Pulse.m4a" type="audio/mp4"> Your browser does not support the audio element. </audio>

    <script src="/js/common/blocklist.js"></script>

    <script>
        /***********************************************
         *          Firebase & Global Vars             *
         ***********************************************/
        // Using placeholder config from Cosmic Dodge
        const firebaseConfig = {
             apiKey: "AIzaSyBop7YMrZIO05yknhCm_mqjbtXP_Gl58sE", // PLACEHOLDER
             authDomain: "cosmicdodge-5ae20.firebaseapp.com", // PLACEHOLDER
             projectId: "cosmicdodge-5ae20", // PLACEHOLDER
             storageBucket: "cosmicdodge-5ae20.appspot.com", // PLACEHOLDER
             messagingSenderId: "940230809594", // PLACEHOLDER
             appId: "1:940230809594:web:0b3b1dabe1e5c2f5f47643" // PLACEHOLDER
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const version = 'gemini_2_5_pro';
        const gameTitle = 'crazy_clicker';
        const leaderboardCollection = `leaderboard_${gameTitle}_${version}`;
        const statsDoc = `stats_${gameTitle}_${version}`;
        const RHYTHM_TOLERANCE_MS = 50; // +/- 50ms tolerance
        // Added Volume/Mute Keys
        const volumeKey = `${gameTitle}_volume`;
        const muteKey = `${gameTitle}_muted_v1`;


        // Game States
        const GameState = {
            WAITING_FOR_NAME: 'WAITING_FOR_NAME',
            WAITING_FOR_FIRST_CLICK: 'WAITING_FOR_FIRST_CLICK',
            WAITING_FOR_SECOND_CLICK: 'WAITING_FOR_SECOND_CLICK',
            PLAYING: 'PLAYING',
            GAME_OVER: 'GAME_OVER'
        };

        let currentState = GameState.WAITING_FOR_NAME;
        let playerName = "";
        let score = 0;
        let firstClickTime = null;
        let secondClickTime = null;
        let taktTime = null; // Time interval between clicks in ms
        let lastValidClickTime = null;
        let missTimeout = null; // Timeout handle for detecting missed takt
        let currentSessionRoundNumber = 0; // Added for local ranking
        let localSessionRankings = {}; // Added for local ranking

        // DOM Elements
        const startScreen = document.getElementById('startScreen');
        const gameScreen = document.getElementById('gameScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const instructionText = document.getElementById('instructionText');
        const finalScoreDisplay = document.getElementById('finalScore');
        const playerNameInput = document.getElementById('playerName');
        const startGameButton = document.getElementById('startGame');
        const nextRoundButton = document.getElementById('nextRoundButton');
        const globalRankingContentStart = document.getElementById('globalRankingContentStart');
        const globalRankingContentGameOver = document.getElementById('globalRankingContentGameOver');
        const globalGamesPlayedStart = document.getElementById("globalGamesPlayedStart");
        const globalGamesPlayedGameOver = document.getElementById("globalGamesPlayedGameOver");
        const localRankingContentEl = document.getElementById('localRankingContent'); // Added for local ranking
        // Added Volume/Mute DOM Elements
        const backgroundMusic = document.getElementById('backgroundMusic');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeSliderLabel = document.getElementById('volumeSliderLabel'); // Although hidden, might be needed
        const muteControlDiv = document.getElementById('muteControl');
        const muteToggle = document.getElementById('muteToggle');
        const muteToggleLabel = document.getElementById('muteToggleLabel'); // Although hidden, might be needed
        const volumeControlContainer = document.getElementById('volumeControlContainer'); // Container for visibility
        // Leaderboard Trigger Elements (Get these early)
        const globalLeaderboardStartBox = document.getElementById('globalLeaderboardStart');
        const globalLeaderboardGameOverBox = document.getElementById('globalLeaderboardGameOver');
        const localRankingBoardBox = document.getElementById('localRankingBoard');
        // NOTE: Modal elements will be assigned inside DOMContentLoaded


        /***********************************************
         *       Firestore Leaderboard & Stats         *
         ***********************************************/
        // Adapted from Cosmic Dodge - Updated logic to show only latest entry per score
        function updateGlobalLeaderboard() {
            // Fetch more to allow filtering for top 100 unique
            const fetchLimit = 200;
            const maxDisplayInline = 10; // Max entries for the inline display
            const maxDisplayModal = 100; // Max entries for the modal display

            db.collection(leaderboardCollection).orderBy("score", "desc").orderBy("timestamp", "desc").limit(fetchLimit).get()
            .then((querySnapshot) => {
                const uniqueEntries = [];
                const scoresSeen = new Set();

                if (!querySnapshot.empty) {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        // Check data validity and if score already displayed and limit not reached
                        if (data && data.score !== undefined && !scoresSeen.has(data.score) && uniqueEntries.length < maxDisplayModal) {
                            uniqueEntries.push({ name: data.playerName || 'Anon', score: data.score });
                            scoresSeen.add(data.score); // Mark score as seen
                        }
                    });
                }

                let inlineHtml = '<p>No scores yet. Be the first!</p>';
                let modalHtml = '<p>No scores yet. Be the first!</p>';

                if (uniqueEntries.length > 0) {
                    // Generate HTML for inline display (Top 10)
                    inlineHtml = '<ol>';
                    inlineHtml += uniqueEntries.slice(0, maxDisplayInline).map(entry => `<li>${entry.name} - Score: ${entry.score}</li>`).join('');
                    inlineHtml += '</ol>';

                    // Generate HTML for modal display (Top 100)
                    modalHtml = '<ol>';
                    modalHtml += uniqueEntries.slice(0, maxDisplayModal).map(entry => `<li>${entry.name} - Score: ${entry.score}</li>`).join('');
                    modalHtml += '</ol>';
                }

                // Update inline displays
                if (globalRankingContentStart) globalRankingContentStart.innerHTML = inlineHtml;
                if (globalRankingContentGameOver) globalRankingContentGameOver.innerHTML = inlineHtml;
                // Update modal display
                if (globalLeaderboardModalContent) globalLeaderboardModalContent.innerHTML = modalHtml;

            }).catch((error) => {
                console.error("Error getting global leaderboard:", error);
                const errorMsg = "<p>Error loading leaderboard.</p>";
                // Update inline displays with error
                if (globalRankingContentStart) globalRankingContentStart.innerHTML = errorMsg;
                if (globalRankingContentGameOver) globalRankingContentGameOver.innerHTML = errorMsg;
                // Update modal display with error
                if (globalLeaderboardModalContent) globalLeaderboardModalContent.innerHTML = errorMsg;
            });
        }

        function addGlobalRecord(finalScore) {
            if (!playerName) { console.warn("Player name missing, cannot add global record."); return; }
            const scoreToSave = Math.max(0, finalScore); // Ensure score is not negative
            db.collection(leaderboardCollection).add({
                playerName: playerName || "Anon",
                score: scoreToSave,
                version: version,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                console.log("Global record added for score:", scoreToSave);
                updateGlobalLeaderboard(); // Refresh leaderboard after adding
            }).catch((error) => console.error("Error adding global record:", error));
        }

        function incrementGlobalGamesPlayed() {
            // Incremented only on game over
            db.collection("globalStats").doc(statsDoc).set({
                totalGamesPlayed: firebase.firestore.FieldValue.increment(1),
                gameTitle: gameTitle,
                version: version
            }, { merge: true })
            .then(() => {
                console.log("Total games incremented.");
                displayGlobalGamesPlayed(); // Refresh display
            }).catch(console.error);
        }

        function displayGlobalGamesPlayed() {
            db.collection("globalStats").doc(statsDoc).get().then((doc) => {
                const total = doc.exists ? (doc.data().totalGamesPlayed || 0) : 0;
                const text = `(Total games played worldwide: ${total})`;
                if (globalGamesPlayedStart) globalGamesPlayedStart.innerText = text;
                if (globalGamesPlayedGameOver) globalGamesPlayedGameOver.innerText = text;
            }).catch((error) => {
                console.error("Error reading total games:", error);
                const errorText = "(Total games played worldwide: Error)";
                if (globalGamesPlayedStart) globalGamesPlayedStart.innerText = errorText;
                if (globalGamesPlayedGameOver) globalGamesPlayedGameOver.innerText = errorText;
            });
        }

         /***********************************************
         *          Name Validation                    *
         ***********************************************/
         function isNameOffensive(name) {
             // Assumes blocklist.js is loaded globally
             if (typeof offensiveWords === 'undefined') {
                 console.warn("Offensive words list (blocklist.js) not loaded!");
                 return false;
             }
             if (!name) return false;
             const lowerCaseName = name.toLowerCase();
             for (const word of offensiveWords) {
                 // Basic substring check
                 if (lowerCaseName.includes(word)) {
                     console.log(`Offensive substring found: ${word} in ${name}`);
                     return true;
                 }
             }
             return false;
         }

        /***********************************************
         *           Volume/Mute Control Logic         *
         ***********************************************/
         // --- Copied & Adapted from Cosmic Dodge ---
         function isIOS() {
             return [
                 'iPad Simulator', 'iPhone Simulator', 'iPod Simulator',
                 'iPad', 'iPhone', 'iPod'
             ].includes(navigator.platform)
             || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
         }
         const runningOnIOS = isIOS(); // Check once on load

         function setupVolumeSliderControl() {
             if (runningOnIOS || !backgroundMusic || !volumeSlider) return;

             const savedVolume = localStorage.getItem(volumeKey);
             let currentVolume = 0.5;
             if (savedVolume !== null && !isNaN(parseFloat(savedVolume))) {
                 currentVolume = parseFloat(savedVolume);
             }
             currentVolume = Math.max(0, Math.min(1, currentVolume));
             volumeSlider.value = currentVolume;
             // Initial volume applied before play()

             const handleVolumeChange = () => {
                 const newVolumeRaw = parseFloat(volumeSlider.value);
                 const newVolume = isNaN(newVolumeRaw) ? 0.5 : Math.max(0, Math.min(1, newVolumeRaw));
                 if (backgroundMusic) { backgroundMusic.volume = newVolume; }
                 try { localStorage.setItem(volumeKey, newVolume.toString()); }
                 catch (e) { console.error("Crazy Clicker: Failed to save volume:", e); }
             };
             volumeSlider.removeEventListener('input', handleVolumeChange);
             volumeSlider.removeEventListener('change', handleVolumeChange);
             volumeSlider.addEventListener('input', handleVolumeChange);
             volumeSlider.addEventListener('change', handleVolumeChange);
             console.log("Crazy Clicker: Volume slider control listeners attached.");
         }

         function setupMuteToggleControl() {
             if (!runningOnIOS || !backgroundMusic || !muteToggle) return;

             let isMuted = localStorage.getItem(muteKey) === 'true';
             muteToggle.checked = isMuted;
             // Initial mute applied before play()

             const handleMuteChange = () => {
                 const shouldMute = muteToggle.checked;
                 if (backgroundMusic) { backgroundMusic.muted = shouldMute; }
                 try { localStorage.setItem(muteKey, shouldMute.toString()); }
                 catch (e) { console.error("Crazy Clicker: Failed to save mute state:", e); }
             };
             muteToggle.removeEventListener('change', handleMuteChange);
             muteToggle.addEventListener('change', handleMuteChange);
             console.log("Crazy Clicker: Mute toggle control listener attached.");
         }
         // --- End Volume/Mute Logic ---


        /***********************************************
         *      Local Ranking (Session Only)           *
         ***********************************************/
         // Updated to populate both inline and modal displays
         function updateLocalRankingBoard() {
             const maxDisplayInline = 10;
             const maxDisplayModal = 100;

             if (!localRankingContentEl || !localLeaderboardModalContent) return;

             const rankingsList = Object.values(localSessionRankings);
             // Sort by score descending
             const sortedRankings = rankingsList.sort((a, b) => b.score - a.score);

             let inlineHtml = '<p>No rounds completed yet.</p>';
             let modalHtml = '<p>No rounds completed yet.</p>';

             if (sortedRankings.length > 0) {
                 // Generate HTML for inline display (Top 10)
                 inlineHtml = '<ol>';
                 inlineHtml += sortedRankings.slice(0, maxDisplayInline).map(entry => `<li>Round ${entry.round}: Score ${entry.score}</li>`).join('');
                 inlineHtml += '</ol>';

                 // Generate HTML for modal display (Top 100)
                 modalHtml = '<ol>';
                 modalHtml += sortedRankings.slice(0, maxDisplayModal).map(entry => `<li>Round ${entry.round}: Score ${entry.score}</li>`).join('');
                 modalHtml += '</ol>';
             }

             // Update inline display
             localRankingContentEl.innerHTML = inlineHtml;
             // Update modal display
             localLeaderboardModalContent.innerHTML = modalHtml;
         }

         function saveLocalRecord(roundNum, finalScore) {
              const scoreToSave = Math.max(0, finalScore);
              // Store using score as key to overwrite previous same scores
              localSessionRankings[scoreToSave] = { round: roundNum, score: scoreToSave };
              updateLocalRankingBoard(); // Update display immediately
         }


        /***********************************************
         *         Game State Management               *
         ***********************************************/
        function transitionToState(newState) {
            console.log(`Transitioning from ${currentState} to ${newState}`);
            currentState = newState;

            // Reset UI elements based on state
            startScreen.style.display = 'none';
            gameScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            clearTimeout(missTimeout); // Clear any pending game over timeout

            switch (newState) {
                case GameState.WAITING_FOR_NAME:
                    startScreen.style.display = 'flex';
                    updateGlobalLeaderboard(); // Refresh leaderboard on start screen
                    displayGlobalGamesPlayed();
                    volumeControlContainer.style.display = 'none'; // Hide volume on start screen
                    // Reset local session if returning to name screen (implies new player/session)
                    currentSessionRoundNumber = 0;
                    localSessionRankings = {};
                    break;
                case GameState.WAITING_FOR_FIRST_CLICK:
                    gameScreen.style.display = 'flex'; // Use flex for centering
                    volumeControlContainer.style.display = 'flex'; // Show volume in game
                    score = 0;
                    firstClickTime = null;
                    secondClickTime = null;
                        taktTime = null;
                        lastValidClickTime = null;
                        scoreDisplay.textContent = score;
                        instructionText.textContent = "Click anywhere for your first beat...";
                        displayGlobalGamesPlayed(); // Refresh count when starting a round
                        // Attempt to play music when game starts
                        if (backgroundMusic && backgroundMusic.paused) {
                            try {
                            // Apply saved volume/mute state BEFORE playing
                            if (runningOnIOS) {
                                if (muteToggle) backgroundMusic.muted = muteToggle.checked;
                            } else {
                                if (volumeSlider) {
                                     let initialVolume = parseFloat(volumeSlider.value);
                                     if (isNaN(initialVolume)) initialVolume = 0.5;
                                     backgroundMusic.volume = Math.max(0, Math.min(1, initialVolume));
                                }
                            }
                            backgroundMusic.play().catch(error => console.log("Crazy Clicker: Music autoplay prevented:", error));
                        } catch (err) {
                            console.error("Crazy Clicker: Error during music setup/play:", err);
                        }
                    }
                    break;
                case GameState.WAITING_FOR_SECOND_CLICK:
                    gameScreen.style.display = 'flex'; // Use flex for centering
                    volumeControlContainer.style.display = 'flex'; // Show volume in game
                    instructionText.textContent = "Click again for your second beat...";
                    break;
                case GameState.PLAYING:
                    gameScreen.style.display = 'flex'; // Use flex for centering
                    volumeControlContainer.style.display = 'flex'; // Show volume in game
                    instructionText.textContent = `Keep the rhythm! (${taktTime}ms)`;
                    // Start the first miss timeout
                    setMissTimeout();
                    break;
                case GameState.GAME_OVER:
                    gameOverScreen.style.display = 'flex';
                    volumeControlContainer.style.display = 'flex'; // Show volume on game over
                    finalScoreDisplay.textContent = `Final Score: ${score}`;
                    triggerRedFlicker();
                    saveLocalRecord(currentSessionRoundNumber, score); // Save local score first
                    addGlobalRecord(score); // Save global score to Firebase
                    incrementGlobalGamesPlayed(); // Increment count *only* on game over
                    updateGlobalLeaderboard(); // Refresh global leaderboard on game over screen
                    updateLocalRankingBoard(); // Refresh local leaderboard display
                    displayGlobalGamesPlayed();
                    break;
            }
        }

        /***********************************************
         *         Game Logic & Event Handlers         *
         ***********************************************/

        function handleScreenClick(event) {
            // Prevent default actions like text selection on double click
            event.preventDefault();

            const now = performance.now();

            switch (currentState) {
                case GameState.WAITING_FOR_FIRST_CLICK:
                    score = 1; // First click counts
                    scoreDisplay.textContent = score;
                    firstClickTime = now;
                    lastValidClickTime = now;
                    triggerGreenFlicker();
                    transitionToState(GameState.WAITING_FOR_SECOND_CLICK);
                    break;

                case GameState.WAITING_FOR_SECOND_CLICK:
                    score++;
                    scoreDisplay.textContent = score;
                    secondClickTime = now;
                    taktTime = Math.round(secondClickTime - firstClickTime);
                    lastValidClickTime = now;

                    if (taktTime <= 0) { // Prevent zero or negative takt time
                        console.warn("Takt time too short, resetting.");
                        transitionToState(GameState.WAITING_FOR_FIRST_CLICK); // Reset
                        return;
                    }
                    triggerGreenFlicker();
                    transitionToState(GameState.PLAYING);
                    break;

                case GameState.PLAYING:
                    clearTimeout(missTimeout); // Clear previous timeout
                    const timeSinceLastClick = now - lastValidClickTime;
                    const lowerBound = taktTime - RHYTHM_TOLERANCE_MS;
                    const upperBound = taktTime + RHYTHM_TOLERANCE_MS;

                    if (timeSinceLastClick >= lowerBound && timeSinceLastClick <= upperBound) {
                        // Click is within rhythm
                        score++;
                        scoreDisplay.textContent = score;
                        lastValidClickTime = now;
                        triggerGreenFlicker();
                        setMissTimeout(); // Set timeout for the next expected click
                    } else {
                        // Click is off rhythm
                        console.log(`Off rhythm: ${timeSinceLastClick}ms vs ${taktTime}ms`);
                        transitionToState(GameState.GAME_OVER);
                    }
                    break;
            }
        }

        function setMissTimeout() {
            // Set timeout slightly after the tolerance window ends
            missTimeout = setTimeout(() => {
                if (currentState === GameState.PLAYING) {
                    console.log("Stopped clicking in rhythm.");
                    transitionToState(GameState.GAME_OVER);
                }
            }, taktTime + RHYTHM_TOLERANCE_MS + 10); // +10ms buffer
        }

        function triggerGreenFlicker() {
            gameScreen.classList.remove('flicker-green'); // Remove first to reset animation
            void gameScreen.offsetWidth; // Trigger reflow
            gameScreen.classList.add('flicker-green');
        }

        function triggerRedFlicker() {
            gameOverScreen.classList.remove('flicker-red');
            void gameOverScreen.offsetWidth;
            gameOverScreen.classList.add('flicker-red');
            // Remove class after animation finishes to allow re-triggering if needed
            setTimeout(() => {
                 gameOverScreen.classList.remove('flicker-red');
            }, 1000); // Match animation duration
        }

        function handleStartGameClick() {
            const nameInput = playerNameInput.value.trim();
            if (nameInput === "") {
                alert("Please enter a player name.");
                return;
            }
            if (isNameOffensive(nameInput)) {
                alert("Please choose a more appropriate player name.");
                return;
            }
             playerName = nameInput.substring(0, 10);
             // Reset session stats when starting with a name
             currentSessionRoundNumber = 1; // Start at round 1
             localSessionRankings = {};
             updateLocalRankingBoard(); // Clear the board display
             transitionToState(GameState.WAITING_FOR_FIRST_CLICK);
         }

         function handleNextRoundClick() {
             currentSessionRoundNumber++; // Increment round number
             transitionToState(GameState.WAITING_FOR_FIRST_CLICK);
         }

         /***********************************************
         *          Initialization                     *
         ***********************************************/
        document.addEventListener('DOMContentLoaded', () => {
            // --- Assign Modal Elements *after* DOM is ready ---
            const globalLeaderboardModal = document.getElementById('globalLeaderboardModal');
            const localLeaderboardModal = document.getElementById('localLeaderboardModal');
            const globalLeaderboardModalContent = document.getElementById('globalLeaderboardModalContent');
            const localLeaderboardModalContent = document.getElementById('localLeaderboardModalContent');
            const closeGlobalModalButton = document.getElementById('closeGlobalModal');
            const closeLocalModalButton = document.getElementById('closeLocalModal');
            // --- End Assign Modal Elements ---

            // Initial setup
            transitionToState(GameState.WAITING_FOR_NAME); // Start at name entry

            // --- ADDED: Conditional UI Setup for Volume/Mute ---
             console.log(`Crazy Clicker: iOS detected: ${runningOnIOS}`);
             if (runningOnIOS) {
                 if(volumeSlider) volumeSlider.style.display = 'none';
                 if(volumeSliderLabel) volumeSliderLabel.style.display = 'none';
                 if(muteControlDiv) muteControlDiv.style.display = 'inline-block'; // Use inline-block
                 setupMuteToggleControl(); // Setup mute checkbox listener for iOS
             } else {
                 if(muteControlDiv) muteControlDiv.style.display = 'none';
                 if(volumeSlider) volumeSlider.style.display = 'inline-block'; // Use inline-block
                 if(volumeSliderLabel) volumeSliderLabel.style.display = 'inline-block'; // Use inline-block
                 setupVolumeSliderControl(); // Setup volume slider listener for non-iOS
             }
             // --- END: Conditional UI Setup ---


            // Event Listeners
            startGameButton.addEventListener('click', handleStartGameClick);
            playerNameInput.addEventListener('keydown', (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    handleStartGameClick();
                }
            });
            gameScreen.addEventListener('click', handleScreenClick);
            gameScreen.addEventListener('touchstart', handleScreenClick, { passive: false }); // Also handle touch
            nextRoundButton.addEventListener('click', handleNextRoundClick);

             // Initial data load
             updateGlobalLeaderboard();
             displayGlobalGamesPlayed();
             updateLocalRankingBoard(); // Initial display for local board

             // --- Modal Event Listeners ---
             // Open Global Modal
             if (globalLeaderboardStartBox) {
                 globalLeaderboardStartBox.addEventListener('click', () => {
                     updateGlobalLeaderboard(); // Refresh data just in case
                     if (globalLeaderboardModal) globalLeaderboardModal.style.display = 'block';
                 });
             }
             if (globalLeaderboardGameOverBox) {
                 globalLeaderboardGameOverBox.addEventListener('click', () => {
                     updateGlobalLeaderboard(); // Refresh data just in case
                     if (globalLeaderboardModal) globalLeaderboardModal.style.display = 'block';
                 });
             }
             // Open Local Modal
             if (localRankingBoardBox) {
                 localRankingBoardBox.addEventListener('click', () => {
                     updateLocalRankingBoard(); // Refresh data
                     if (localLeaderboardModal) localLeaderboardModal.style.display = 'block';
                 });
             }

             // Close Modals via Button
             if (closeGlobalModalButton) {
                 closeGlobalModalButton.addEventListener('click', () => {
                     if (globalLeaderboardModal) globalLeaderboardModal.style.display = 'none';
                 });
             }
             if (closeLocalModalButton) {
                 closeLocalModalButton.addEventListener('click', () => {
                     if (localLeaderboardModal) localLeaderboardModal.style.display = 'none';
                 });
             }

             // Close Modals via Background Click
             window.addEventListener('click', (event) => {
                 if (event.target === globalLeaderboardModal) {
                     globalLeaderboardModal.style.display = 'none';
                 }
                 if (event.target === localLeaderboardModal) {
                     localLeaderboardModal.style.display = 'none';
                 }
             });
             // --- End Modal Event Listeners ---

         });

     </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const globalLeaderboardModal = document.getElementById('globalLeaderboardModal');
            const localLeaderboardModal = document.getElementById('localLeaderboardModal');
            const closeGlobalModalButton = document.getElementById('closeGlobalModal');
            const closeLocalModalButton = document.getElementById('closeLocalModal');
            const globalLeaderboardStartBox = document.getElementById('globalLeaderboardStart');
            const localRankingBoardBox = document.getElementById('localRankingBoard');

            // Open Global Leaderboard Modal
            globalLeaderboardStartBox.addEventListener('click', () => {
                globalLeaderboardModal.style.display = 'block';
                globalLeaderboardModal.setAttribute('aria-hidden', 'false');
                closeGlobalModalButton.focus(); // Set focus to close button
            });

            // Open Local Leaderboard Modal
            localRankingBoardBox.addEventListener('click', () => {
                localLeaderboardModal.style.display = 'block';
                localLeaderboardModal.setAttribute('aria-hidden', 'false');
                closeLocalModalButton.focus(); // Set focus to close button
            });

            // Close Global Leaderboard Modal
            closeGlobalModalButton.addEventListener('click', () => {
                globalLeaderboardModal.style.display = 'none';
                globalLeaderboardModal.setAttribute('aria-hidden', 'true');
                globalLeaderboardStartBox.focus(); // Return focus to the trigger
            });

            // Close Local Leaderboard Modal
            closeLocalModalButton.addEventListener('click', () => {
                localLeaderboardModal.style.display = 'none';
                localLeaderboardModal.setAttribute('aria-hidden', 'true');
                localRankingBoardBox.focus(); // Return focus to the trigger
            });

            // Close modals when clicking outside the modal content
            window.addEventListener('click', (event) => {
                if (event.target === globalLeaderboardModal) {
                    globalLeaderboardModal.style.display = 'none';
                    globalLeaderboardModal.setAttribute('aria-hidden', 'true');
                    globalLeaderboardStartBox.focus(); // Return focus to the trigger
                }
                if (event.target === localLeaderboardModal) {
                    localLeaderboardModal.style.display = 'none';
                    localLeaderboardModal.setAttribute('aria-hidden', 'true');
                    localRankingBoardBox.focus(); // Return focus to the trigger
                }
            });

            // Close modals when pressing the Escape key
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (globalLeaderboardModal.style.display === 'block') {
                        globalLeaderboardModal.style.display = 'none';
                        globalLeaderboardModal.setAttribute('aria-hidden', 'true');
                        globalLeaderboardStartBox.focus(); // Return focus to the trigger
                    }
                    if (localLeaderboardModal.style.display === 'block') {
                        localLeaderboardModal.style.display = 'none';
                        localLeaderboardModal.setAttribute('aria-hidden', 'true');
                        localRankingBoardBox.focus(); // Return focus to the trigger
                    }
                }
            });
        });
    </script>

    <!-- Cloudflare Web Analytics -->
    <script defer src="https://static.cloudflareinsights.com/beacon.min.js"
            data-cf-beacon='{"token":"7e23bb1be08e4d83bb66013aab939d1e"}'></script>

    <!-- Global Leaderboard Modal -->
    <div id="globalLeaderboardModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeGlobalModal">&times;</span>
            <div class="modal-header">Global Leaderboard</div>
            <div class="modal-body" id="globalLeaderboardModalContent">
                <p>Loading...</p>
            </div>
        </div>
    </div>

    <!-- Local Leaderboard Modal -->
    <div id="localLeaderboardModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeLocalModal">&times;</span>
            <div class="modal-header">Local Session Ranking</div>
            <div class="modal-body" id="localLeaderboardModalContent">
                <p>No rounds completed yet.</p>
            </div>
        </div>
    </div>

</div> <!-- Closed Wrapper -->
</body>
</html>
